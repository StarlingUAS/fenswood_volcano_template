<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>3. Packaging your controller into a container - Fenswood Volcano Tutorial</title>
<link href="../../css/theme.css" rel="stylesheet"/>
<link href="../../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "3. Packaging your controller into a container";
        var mkdocs_page_input_path = "advanced/containers.md";
        var mkdocs_page_url = null;
      </script>
<script defer="" src="../../js/jquery-3.6.0.min.js"></script>
<!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../.."> Fenswood Volcano Tutorial
        </a><div role="search">
<form action="../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<p class="caption"><span class="caption-text">Core Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/getting_started/">1. Getting Started</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/drone_control/">2. Controlling a Drone using Mavlink Over ROS</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/old_school/">3. An Old-School Example</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/simple_class/">4. Implementing the contorller as a class</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/modular/">5. A More Modular Controller</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/finite_state/">6. Adding A Finite State Machine</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/ros_timer/">7. Using A Ros Timer</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/perception/">8. Adding Perception</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/conclusion/">9. Conclusion and Next Steps</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Advanced Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../starling/">1. Brief Starling Introduction</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ros_package/">2. Developing a ROS package</a>
</li>
<li class="toctree-l1 current"><a class="reference internal current" href="./">3. Packaging your controller into a container</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#containers">12.1 Containers</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-containerisation-and-docker">12.1.1 What is Containerisation and Docker</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#docker-concepts-in-more-detail">12.1.2 Docker Concepts in more detail</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#docker-and-starling">12.1.3 Docker and Starling</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#packaging-your-controller">12.2 Packaging your controller</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#anatomy-of-a-docker-container">12.2.1 Anatomy of a Docker Container</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-dockerfile">12.2.2 Writing a Dockerfile</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-a-docker-container">12.2.3 Building a Docker container</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exercises">12.3 Exercises</a>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../local_testing/">4. Local Development and Testing</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../..">Fenswood Volcano Tutorial</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a alt="Docs" class="icon icon-home" href="../.."></a> »</li>
<li>Advanced Tutorial »</li>
<li>3. Packaging your controller into a container</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/StarlingUAS/fenswood_volcano_template/edit/master/docs/advanced/containers.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="packaging-up-your-controller-into-a-container"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.</span> Packaging up your controller into a container<a class="headerlink" href="#packaging-up-your-controller-into-a-container" title="Permanent link">¶</a></h1>
<div class="toc">
<ul>
<li><a href="#packaging-up-your-controller-into-a-container">12. Packaging up your controller into a container</a><ul>
<li><a href="#containers">12.1 Containers</a><ul>
<li><a href="#what-is-containerisation-and-docker">12.1.1 What is Containerisation and Docker</a></li>
<li><a href="#docker-concepts-in-more-detail">12.1.2 Docker Concepts in more detail</a></li>
<li><a href="#docker-and-starling">12.1.3 Docker and Starling</a></li>
</ul>
</li>
<li><a href="#packaging-your-controller">12.2 Packaging your controller</a><ul>
<li><a href="#anatomy-of-a-docker-container">12.2.1 Anatomy of a Docker Container</a></li>
<li><a href="#writing-a-dockerfile">12.2.2 Writing a Dockerfile</a></li>
<li><a href="#building-a-docker-container">12.2.3 Building a Docker container</a></li>
</ul>
</li>
<li><a href="#exercises">12.3 Exercises</a></li>
</ul>
</li>
</ul>
</div>
<p><a href="../../#contents">Back to tutorial contents</a></p>
<h2 id="containers"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.1</span> Containers<a class="headerlink" href="#containers" title="Permanent link">¶</a></h2>
<p>As you may have guessed, Starling heavily makes use of "docker containers" for the encapsulation and execution of our applications.</p>
<p>In fact, throughout these tutorials, we have constantly been referring to "application containers", "containers", "docker container" and so on. So far we have simply asked you to consider them as mini operating systems or virtual machines. But perhaps now is a good time to go into a little more detail.</p>
<h3 id="what-is-containerisation-and-docker"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.1.1</span> What is Containerisation and Docker<a class="headerlink" href="#what-is-containerisation-and-docker" title="Permanent link">¶</a></h3>
<p>It would be nice to give a computer - any computer with an internet connection - a short string of ASCII characters (say via a keyboard), press enter, and return to see some program running. Forget about where the program was built or what software you happened to be running at the time (this can be checked, and we can fetch the necessary dependencies). Sounds simple, right? In fact, this is an engineering task that has taken thousands of the world’s brightest developers many decades to implement.</p>
<p>Thanks to the magic of container technology we now can run any Linux program on almost any networked device on the planet, as is. All of the environment preparation, installation and configuration steps can be automated from start to finish. Depending on how much network bandwidth you have, it might take a while, but that’s all right. All you need to do is type the string correctly.</p>
<p>Docker is one very widely used example of containerisation technology, and the one we make use of in Starling. They provide a large number of tools and programs to help us contain, develop, test and deploy our containers to the real world.</p>
<p>If you followed the <a href="getting_started.md">getting started</a>, you should hopefully have done the full docker install. If not, you can run the following command from a linux command line to install basic docker.</p>
<pre><code> curl -sSL https://get.docker.com/ | sh
</code></pre>
<h3 id="docker-concepts-in-more-detail"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.1.2</span> Docker Concepts in more detail<a class="headerlink" href="#docker-concepts-in-more-detail" title="Permanent link">¶</a></h3>
<blockquote>
<p>Adapted from <a href="https://www.docker.com/resources/what-container/">Docker Resources</a></p>
</blockquote>
<p>A <strong>container</strong> is a standard unit of software that packages up code and all its dependencies so the application runs quickly and reliably from one computing environment to another. A Docker container image is a lightweight, standalone, executable package of software that includes everything needed to run an application: code, runtime, system tools, system libraries and settings.</p>
<p>Container <strong>images</strong> become containers at runtime and in the case of Docker containers – images become containers when they run on Docker Engine. Available for both Linux and Windows-based applications, containerized software will always run the same, regardless of the infrastructure. Containers isolate software from its environment and ensure that it works uniformly despite differences for instance between development and staging.</p>
<p>Containers are <em>Standard</em> (can run anywhere), <em>Lightweight</em> (Share low level machine system and not the whole Operating System) and <em>Secure</em> (Each application is as isolated as possible). For us this also translates to providing <em>Reproduceable</em> and <em>Reusable</em> systems.</p>
<p><img alt="container_vs_vm" src="../container_vm.png"/></p>
<p>On the left, Containers are an abstraction at the app layer that packages code and dependencies together. Multiple containers can run on the same machine and share the OS kernel with other containers, each running as isolated processes in user space. Containers take up less space than VMs (container images are typically tens of MBs in size), can handle more applications and require fewer VMs and Operating systems.</p>
<p>On the right, Virtual machines (VMs) are an abstraction of physical hardware turning one server into many servers. The hypervisor allows multiple VMs to run on a single machine. Each VM includes a full copy of an operating system, the application, necessary binaries and libraries – taking up tens of GBs. VMs can also be slow to boot.</p>
<h3 id="docker-and-starling"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.1.3</span> Docker and Starling<a class="headerlink" href="#docker-and-starling" title="Permanent link">¶</a></h3>
<p>Then to connect things back to Starling - The purpose of Starling is to allow you to quickly and easily install and run a UAV simulation within a simulated environment, so that you can test your developed controllers against a semi-realistic scenario, to then test in the real world</p>
<p>Therefore Starling is a set of pre-built programs/executables, some of which are pre-configured for the following:</p>
<ul>
<li>Running a Physics Simulation with Visualisation</li>
<li>Running the Drone autopilot control software locally (a.k.a Software In The Loop or SITL)</li>
<li>Running the interface between Mavlink and other protocols such as the Robot Operating System (ROS)</li>
<li>And many others...</li>
</ul>
<p>These pre-built containers are all available in the <a href="https://github.com/StarlingUAS">StarlingUAS repository on github</a> and on Docker Hub.</p>
<h2 id="packaging-your-controller"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.2</span> Packaging your controller<a class="headerlink" href="#packaging-your-controller" title="Permanent link">¶</a></h2>
<h3 id="anatomy-of-a-docker-container"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.2.1</span> Anatomy of a Docker Container<a class="headerlink" href="#anatomy-of-a-docker-container" title="Permanent link">¶</a></h3>
<p>From the user's perspective, a Docker image / container is simply the operating system and essentials - such as installationas, application code, and dependencies. In Starling we create Docker images by using a <strong>Dockerfile</strong> - a plain text file that provides the specifications for creating a Docker image.</p>
<blockquote>
<p>See <a href="https://jfrog.com/knowledge-base/a-beginners-guide-to-understanding-and-building-docker-images/">this post</a> for more details</p>
</blockquote>
<p>In Starling, a controller Docker container is based on the following image template <a href="https://github.com/StarlingUAS/ProjectStarling/blob/master/system/controller-base/Dockerfile"><code>uobflightlabstarling/starling-controller-base:latest</code></a></p>
<ul>
<li>It is based on the Ubuntu 20.04 distribution (focal)</li>
<li>It has ROS2 FOXY installed in it</li>
<li>It has <code>mavros_msgs</code> and a number of other related packages already installed</li>
<li>There exists a folder in the root directory <code>/ros_ws</code> which will contain all user space code. This is the ROS2 workspace. Your application source goes into <code>/ros_ws/src</code>.</li>
</ul>
<h3 id="writing-a-dockerfile"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.2.2</span> Writing a Dockerfile<a class="headerlink" href="#writing-a-dockerfile" title="Permanent link">¶</a></h3>
<p>The <strong>Dockerfile</strong> which specifies your controller is at <code>fenswood_drone_controller/Dockerfile</code> and should look something like the following:</p>
<pre><code class="language-Dockerfile">1.  FROM uobflightlabstarling/starling-controller-base:latest
2.
3.  RUN apt update
4.  RUN apt-get install -y ros-foxy-vision-opencv python3-pip
5.  RUN pip3 install opencv-python
6.
7.  COPY . /ros_ws/src/fenswood_drone_controller
8.
9.  RUN . /ros_ws/install/setup.sh \
     &amp;&amp; colcon build
10.
11. CMD [ "ros2", "launch", "fenswood_drone_controller", "controller.launch.xml" ]
</code></pre>
<p>When you build a Dockerfile, Docker reads and executes the commands specified line by line. This is similar to when you have a blank linux distribution and start typing instructions to install libraries and applications. Breaking it down line by line:</p>
<pre><code class="language-Dockerfile">1.  FROM uobflightlabstarling/starling-controller-base:latest
</code></pre>
<p>This line (the <code>FROM</code>) tells the builder the Docker image which we should build upon or augment. In this case we are building your application on top of the controller base image.</p>
<pre><code class="language-Dockerfile">3.  RUN apt update
4.  RUN apt-get install -y ros-foxy-vision-opencv python3-pip
5.  RUN pip3 install opencv-python
</code></pre>
<p>Here we are installing the key libraries using <code>apt-get</code> and <code>pip3</code>, the package managers for ubuntu and python respectively. These libraries are not included in the base image, so we need to add them before your application can run. If you find you need any other dependencies, you will need to install them here.</p>
<p>The <code>RUN</code> command tells Docker to simply run the given command inside the container.</p>
<blockquote>
<p>Simply installing the dependencies on your local machine will do nothing inside the container.</p>
</blockquote>
<pre><code class="language-Dockerfile">7.  COPY . /ros_ws/src/fenswood_drone_controller
</code></pre>
<p>This <code>COPY</code> command then takes everything locally in the same directory as the Dockerfile (specified using dot <code>.</code>) and copies it into the container at the path given. This is a normal way of getting files from your local system into the container.</p>
<blockquote>
<p><em>Note:</em> Copy will literally copy the state of all of your files at the time of building. Any new changes to your files will not be reflected in the container until your build again. However, there are ways to allow you to do live editing inside the container - see <a href="https://docs.docker.com/storage/bind-mounts/">bind mounts</a> - we will need these if you want to get data out.</p>
</blockquote>
<pre><code class="language-Dockerfile">9.  RUN . /ros_ws/install/setup.sh \
     &amp;&amp; colcon build
</code></pre>
<p>This line then compiles your ros nodes. The first command <code>. /ros_ws/install/setup.sh</code> <em>sources</em> ROS2. That means it makes the ROS2 command line commands available for the terminal to use. The second command <code>colcon build</code>. Then builds all of the ros nodes it can find in the <code>src</code> directory. This is the step which builds your container.</p>
<blockquote>
<p><em>Note:</em> All <code>RUN</code> commands are run inside the <code>/ros_ws</code> folder. This was specified in the parent image. So <code>colcon build</code> is run inside <code>/ros_ws</code> and therefore looks for ros packages inside <code>/ros_ws/src</code></p>
</blockquote>
<pre><code class="language-Dockerfile">11. CMD [ "ros2", "launch", "fenswood_drone_controller", "controller.launch.xml" ]
</code></pre>
<p>Finally, the <code>CMD</code> specifies the command that the Docker image will run when run. Here, by default, the docker contaienr will launch the <code>controller.launch.xml</code> launch file from within <code>fenswood_drone_controller</code></p>
<blockquote>
<p><em>Note:</em> This command is run inside the container using the bash shell. There is a hidden file called <code>/ros_entrypoint.sh</code> which is sourced just before running the command. This entrypoint file sources ros and the <code>/ros_ws</code> workspace so bash knows about your local ros nodes.</p>
<p><em>Note:</em> this CMD can and often is over-ridden. See any of the docker-compose files where we run one of the other controllers.</p>
</blockquote>
<h3 id="building-a-docker-container"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.2.3</span> Building a Docker container<a class="headerlink" href="#building-a-docker-container" title="Permanent link">¶</a></h3>
<p>Now we have the Dockerfile, the only thing left to do is build it. There are 2 ways:</p>
<ol>
<li>
<p>Using the Docker command line tool from the root of this repository. This will create a new docker image called <code>my_application</code> which you can then run.</p>
<pre><code>docker build -t my_application fenswood_drone_controller
docker run my_application
</code></pre>
</li>
<li>
<p>Using Docker-Compose, which is how we've been doing it for the majority of this tutorial. In the docker-compose.yml we specify the relative path to the Dockerfile and docker-compose will build the application for us.</p>
<pre><code>controller:
    build: ../fenswood_drone_controller
</code></pre>
</li>
</ol>
<blockquote>
<p><em>Note:</em> There is a 3rd method which uses <code>docker buildx</code> which you might see in some of the other Starling projects. This is needed in order to build containers for other computer architectures - such as for the raspberry pi which runs on an Arm64 chip (aka cross-platform). We may cover this at a later date.</p>
<p><em>Note:</em> The build process uses caching to speed up. The Dockerfile commands are run in order so if an earlier command has not changed, or it detects no changes, it will only rebuild the new stuff.
</p>
</blockquote>
<h2 id="exercises"><span class="enumerate-headings-plugin enumerate-heading-plugin">12.3</span> Exercises<a class="headerlink" href="#exercises" title="Permanent link">¶</a></h2>
<ol>
<li>Add a new dependency into your code (e.g. use the scipy library for something small). Try and add it to your Dockerfile and rebuild.</li>
<li>Change the <code>CMD</code> line to run a different controller launch file by default.</li>
</ol>
<p><a href="../../#contents">Back to tutorial contents</a></p>
</div>
</div><footer>
<div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-left" href="../ros_package/" title="2. Developing a ROS package"><span class="icon icon-circle-arrow-left"></span> Previous</a>
<a class="btn btn-neutral float-right" href="../local_testing/" title="4. Local Development and Testing">Next <span class="icon icon-circle-arrow-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
<p>Copyright © 2022 University of Bristol Flight Laboratory</p>
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span>
<a class="fa fa-github" href="https://github.com/StarlingUAS/fenswood_volcano_template" style="color: #fcfcfc"> GitHub</a>
</span>
<span><a href="../ros_package/" style="color: #fcfcfc">« Previous</a></span>
<span><a href="../local_testing/" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script>var base_url = '../..';</script>
<script defer="" src="../../js/theme_extra.js"></script>
<script defer="" src="../../js/theme.js"></script>
<script defer="" src="../../search/main.js"></script>
<script defer="">
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>
</body>
</html>
